name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        go-version: [ '1.21', '1.22', '1.23', '1.24', '1.25' ]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}
    
    - name: Verify dependencies
      run: |
        go version
        go mod verify
    
    - name: Build
      run: |
        go build -v ./cmd/go-to-run
    
    - name: Test
      run: |
        go test -v ./...
    
    - name: Lint
      uses: golangci/golangci-lint-action@v3
      with:
        version: latest
        args: --timeout=5m

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'
    
    - name: Build for Linux
      run: |
        GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o go-to-run-linux ./cmd/go-to-run
        GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o go-to-run-linux-arm64 ./cmd/go-to-run
    
    - name: Build for Windows
      run: |
        GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o go-to-run.exe ./cmd/go-to-run
    
    - name: Build for macOS
      run: |
        GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o go-to-run-macos ./cmd/go-to-run
        GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o go-to-run-macos-arm64 ./cmd/go-to-run
    
    - name: Create release archive
      run: |
        mkdir -p dist
        zip -j dist/go-to-run-linux-amd64.zip go-to-run-linux
        zip -j dist/go-to-run-linux-arm64.zip go-to-run-linux-arm64
        zip -j dist/go-to-run-windows-amd64.zip go-to-run.exe
        zip -j dist/go-to-run-macos-amd64.zip go-to-run-macos
        zip -j dist/go-to-run-macos-arm64.zip go-to-run-macos-arm64
    
    - name: Create checksums
      run: |
        cd dist
        sha256sum * > checksums.txt
    
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/go-to-run-linux-amd64.zip
          dist/go-to-run-linux-arm64.zip
          dist/go-to-run-windows-amd64.zip
          dist/go-to-run-macos-amd64.zip
          dist/go-to-run-macos-arm64.zip
          dist/checksums.txt